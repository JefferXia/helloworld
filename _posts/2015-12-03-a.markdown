---
layout: post
title:  "总结做H5遇到的坑"
date:   2015-12-03 17:39:16
categories: mobile
---

### 移动端浏览器300毫秒点击延时

#### 解决方案

1. 禁止页面缩放

由于双击缩放仅对于可被缩放的页面有存在意义，那么对于不可缩放的页面，就可以直接去掉点击延时。

Android 平台的 Chrome 32 及以上版本浏览器和 Firefox 浏览器率先支持了这一特性。

通过设置页面的 meta 标签来禁止页面缩放：

{% highlight ruby %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
{% endhighlight %}

2. 禁止双击缩放

在 Chrome 32 及以上版本中，他们将在包含 width=device-width 或者置为比 viewport 值更小的页面上禁用双击缩放：

{% highlight ruby %}
<meta name="viewport" content="width=device-width">
{% endhighlight %}

在 IE10 和 IE11 通过设置 touch-action 这个CSS属性来禁止双击缩放：

{% highlight ruby %}
body {
    -ms-touch-action: none; /* IE10 */
    touch-action: none;     /* IE11 */
}
{% endhighlight %}

3. FastClick

FastClick是FT Labs专门为解决移动端浏览器 300 毫秒点击延迟问题所开发的一个轻量级的库。简而言之，FastClick 在检测到 touchend 事件的时候，会通过 DOM 自定义事件立即触发一个模拟 click 事件，并把浏览器在 300 毫秒之后真正触发的click事件阻止掉。

FastClick 的使用方法非常简单，在 window load 事件之后，在body上调用FastClick.attach()即可。

{% highlight ruby %}
window.addEventListener( "load", function() {
    FastClick.attach( document.body );
}, false );
{% endhighlight %}

attach方法虽可在更具体的元素上调用，直接绑定到body上可以确保整个应用都能受益。当 FastClick 检测到当前页面使用meta设置了user-scalable=no或者 touch-action 属性的解决方案时，会静默退出。可以说，这是真正的跨平台方案出来之前一种很好的变通方案。

4. 奇技淫巧

tap点击后生成一个透明的遮罩层来阻止点击穿透。

{% highlight ruby %}
stopEventTap: function () {
    var $el = $('<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; "></div>');
    $('body').append($el);
    setTimeout(function () {
        $el.remove();
    }, 500);
}
{% endhighlight %}

### 移动端无法准确判断出checkbox的选中状态

在移动端，checkbox选中状态下获取的.attr(‘checked’) 或者prop(‘checked’) 并不总是 true，如果点击快一点经常会失准，实际交互中会导致选中了但没触发后续动作。 

1、当checkbox选中时加一个class，同时也可以用class去展现checkbox选中的样式，通过判断有无这个class来判断是否选中，这样绝不会错！

2、用:checked选择器，查了中文版的w3school，居然只有Opera支持，查了英文版发现除了IE6-8其实都支持，所以在端移动端用完全没问题。

![1](http://img4.tbcdn.cn/L1/461/1/0b8fc7ab42cfd84f991cb36fd4d9ca6686c5e309.png)

{% highlight ruby %}
// css
input:checked + label {
     color: red;   
}

// js判断是否选中
if($('input[name="ck"]:checked')[0]) {}

// js选中
$('input[name="ck"]').attr("checked", true).prop("checked", true);
{% endhighlight %}


### 1像素边框引起的页面内容溢出

用flexbox去做等分两列的时候，中间有一根分割线，如果用border去做，会导致iPhone4s下页面总宽度多出1像素，从而导致页面可以左右拖动。

![2](http://img2.tbcdn.cn/L1/461/1/67e3514bcf36bd2d13be390a666ed62c1a7dd877.png)

html:
{% highlight ruby %}
<div class="box">
    <div class="left">左侧区块</div>
    <div class="right">右侧区块</div>
</div>
{% endhighlight %}

css:
{% highlight ruby %}
.box {
     display: -webkit-box;
     display: -webkit-flex;
     display: flex;
 }
 .left, .right {
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    flex: 1;
    display: block;
    width: 1px;
    height: 40px;
    position: relative;
}
.left {
    border-right: 1px solid #ccc;
}
{% endhighlight %}

可以用伪元素这样写，问题就解决了
{% highlight ruby %}
.left:after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    width: 1px;
    height: 100%;
    background-color: #ccc;
    display: block;
    z-index: 9;
}
{% endhighlight %}


### ios下双击页面空白处会导致页面上移一段距离

解决方案：拦截模拟的双击事件

{% highlight ruby %}
var lastTouch = 0; //缓存上一次tap的时间
if(utils.isIOS()){
  document.body.addEventListener('touchend', function(event) {
      var nowTouch = new Date().getTime(),
      delta = nowTouch - lastTouch;
      if (delta < 500 && delta > 0) {
          event.preventDefault();
          return false;
      }
      lastTouch = nowTouch;
  }, false);
}
{% endhighlight %}


### 其他

1、手机端绑定输入框的keyup事件监听不到【删除】或者【确定】键，会导致输入的内容提交后最后几个字是拼音，建议同时绑定keyup和change。

2、下面这行样式会影响fixed的正常浮动定位功能（如果在fixed元素外层元素设置了这个样式，fixed元素失效。） 
transform: translate3d(0,0,0);

3、消除transition闪屏

两个方法：使用css3动画的时尽量利用3D加速，从而使得动画变得流畅。动画过程中的动画闪白可以通过 backface-visibility 隐藏。

{% highlight ruby %}
-webkit-transform-style: preserve-3d;
/*设置内嵌的元素在 3D 空间如何呈现：保留 3D*/
-webkit-backface-visibility: hidden;
/*（设置进行转换的元素的背面在面对用户时是否可见：隐藏）*/
{% endhighlight %}

4、Andriod 上去掉语音输入按钮

{% highlight ruby %}
input::-webkit-input-speech-button {display: none}
{% endhighlight %}

5、IP5的媒体查询

{% highlight ruby %}
@media (device-height: 568px) and (-webkit-min-device-pixel-ratio: 2) {

/* iPhone 5 or iPod Touch 5th generation */

}
{% endhighlight %}

媒体查询，响应不同启动图片

{% highlight ruby %}
<link href="startup-568h.png" rel="apple-touch-startup-image" media="(device-height: 568px)">
<link href="startup.png" rel="apple-touch-startup-image" sizes="640x920" media="(device-height: 480px)">
{% endhighlight %}

6、关于 iOS 系统中，中文输入法输入英文时，字母之间可能会出现一个六分之一空格。可以通过正则去掉

{% highlight ruby %}
this.value = this.value.replace(/\u2006/g, '');
{% endhighlight %}

